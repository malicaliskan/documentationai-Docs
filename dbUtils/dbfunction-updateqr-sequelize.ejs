const { HttpServerError, BadRequestError } = require("common");

const {<%= dbObject.modelName %>} = require('models');
const { Op } = require("sequelize");
const { ElasticIndexer } = require("serviceCommon");

const update<%= dbObject.modelName %>ByQuery = async (dataClause,query) => {
    try {
      if (!query || typeof query !== "object") {
        throw new BadRequestError("Invalid query provided. Query must be an object.");
      }
      let rowsCount = null;
      let rows = null;
      <% if (dbObject.objectSettings.basicSettings.useSoftDelete) { %>
      const options =  {where: {[Op.and]: [query,{isActive:true}]},returning: true};
      <% } else { %>
      const options =  {where: query,returning: true};
      <% } %>
      [rowsCount, rows] = await <%= dbObject.modelName %>.update(dataClause,options);

      if (!rowsCount) return [];

      const elasticIndexer = new ElasticIndexer("<%= dbObject.objectName %>");
      for (const item of rows) {
        await elasticIndexer.indexData(item.getData());
      }

      return rows.map(item => item.getData());
    } catch (err) {
      //**errorLog
      throw new HttpServerError("errMsg_dbErrorWhenUpdating<%= dbObject.modelName %>ByQuery", err);
    }
};

module.exports =  update<%= dbObject.modelName %>ByQuery;