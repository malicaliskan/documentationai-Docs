const { 
  HttpServerError, 
  BadRequestError,
  NotFoundError
} = require("common");

const { <%= dbObject.modelName %> } = require('models');

const getIdListOf<%= dbObject.modelName %>ByField = async (fieldName, fieldValue, isArray) => {

  try {


      <% const propertyNames = dbObject.properties.map(property => `"${property.name}"`); %>
      const <%= dbObject.objectName %>Properties = ["id",<%-  propertyNames.join(","), "isActive" %>];
      
      if (!<%= dbObject.objectName %>Properties.includes(fieldName)) {
        throw new BadRequestError(`Invalid field name: ${fieldName}.`);
      }

      // type validation different from sequelize for mongodb
      const schemaPath = <%= dbObject.modelName %>.schema.paths[fieldName];
      if (schemaPath && fieldValue !== undefined && fieldValue !== null) {
        const expectedType = schemaPath.instance.toLowerCase();
        const actualType = typeof fieldValue;
        
        const typeMapping = {
          'string': 'string',
          'number': 'number', 
          'boolean': 'boolean',
          'objectid': 'string' // ObjectIds are typically passed as strings
        };
        
        const expectedJSType = typeMapping[expectedType];
        if (expectedJSType && actualType !== expectedJSType) {
          throw new BadRequestError(`Invalid field value type for ${fieldName}. Expected ${expectedJSType}, got ${actualType}.`);
        }
      }

      let query = isArray 
          ? { [fieldName]: { $in: Array.isArray(fieldValue) ? fieldValue : [fieldValue] } }
          : { [fieldName]: fieldValue };

      <% if (dbObject.objectSettings.basicSettings.useSoftDelete) { %>
      query.isActive = true;
      <% } %>



      let <%= dbObject.objectName %>IdList = await <%= dbObject.modelName %>
          .find(query, { _id: 1 })
          .lean()
          .exec();

      if (!<%= dbObject.objectName %>IdList || <%= dbObject.objectName %>IdList.length === 0) {
        throw new NotFoundError(
          `<%= dbObject.modelName %> with the specified criteria not found`
        );      
      }

      <%= dbObject.objectName %>IdList = <%= dbObject.objectName %>IdList.map(item => item._id.toString());
       
      return <%= dbObject.objectName %>IdList;

  } catch (err) {
      //**errorLog
      throw new HttpServerError("errMsg_dbErrorWhenRequesting<%= dbObject.modelName %>IdListByField", err);
  }
};

module.exports = getIdListOf<%= dbObject.modelName %>ByField;
