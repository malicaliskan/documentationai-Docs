const { HttpServerError, BadRequestError, NotFoundError } = require("common");
const { <%= dbObject.modelName %> } = require("models");
const { ElasticIndexer } = require("serviceCommon");

const indexDataToElastic = async (id) => {
  const elasticIndexer = new ElasticIndexer("<%= dbObject.objectName %>");
  await elasticIndexer.deleteData(id);
};

const delete<%= dbObject.modelName %>ById = async (id) => {
  try {
    if (typeof id === "object") {
      id = id.id;
    }
    if (!id) throw new BadRequestError("ID is required in utility delete function");
    
    <% if (dbObject.objectSettings.basicSettings.useSoftDelete) { %>
    const existingDoc = await <%= dbObject.modelName %>.findOne({ 
      _id: id, 
      isActive: true 
    });
    
    if (!existingDoc) {
      throw new NotFoundError(`Record with ID ${id} not found.`);
    }

    const options = { new: true };
    const dataClause = {isActive: false,_archivedAt: new Date() };

    const deletedDoc = await <%= dbObject.modelName %>.findOneAndUpdate(
      { _id: id, isActive: true }, 
      dataClause,
      options
    );

    await indexDataToElastic(id);

    return deletedDoc.getData(); 
    <% } else { %>
    const existingDoc = await <%= dbObject.modelName %>.findById(id);
    
    if (!existingDoc) {
      throw new NotFoundError(`Record with ID ${id} not found.`);
    }

    await <%= dbObject.modelName %>.findByIdAndDelete(id);
    await indexDataToElastic(id);

    return existingDoc.getData(); 
    <% } %>
    
  } catch (err) {
    if (err instanceof NotFoundError) {
      throw err;
    }
    //**errorLog
    throw new HttpServerError("errMsg_dbErrorWhenUpdating<%= dbObject.modelName %>ById", err);
  }
};

module.exports = delete<%= dbObject.modelName %>ById;
