<% 
const baseNameField = 
  dbObject.properties.find(prop => prop.name == 'shortname')?.name 
    ?? dbObject.properties.find(prop => prop.name == 'name')?.name;

 %>

const { HttpServerError } = require("common");

let {<%= dbObject.modelName %>} = require('models');
const { Op, fn, col, where, literal } = require('sequelize');

const getNextCodenameFor<%= dbObject.modelName %> = async (<%= baseNameField %>) => {
    try {
           
            const escaped = <%= baseNameField %>.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regexPattern = `^${escaped}(\\d+)?$`;
 //should i integrate soft delete part here         
            <% if (dbObject.objectSettings.basicSettings.useSoftDelete) { %>
            const matchingRecords = await <%= dbObject.modelName %>.findAll({
              attributes: ['codename'],
              where: {
                [Op.and]: [
                  where(
                    col('codename'),
                    {
                      [Op.regexp]: regexPattern
                    }
                  ),
                  { isActive: true }
                ]
              }
            });
            <% } else { %>
            const matchingRecords = await <%= dbObject.modelName %>.findAll({
              attributes: ['codename'],
              where: where(
                col('codename'),
                {
                  [Op.regexp]: regexPattern
                }
              )
            });
            <% } %>
          
            const taken = new Set();
          
            matchingRecords.forEach(({ codename }) => {
              const match = codename.match(new RegExp(`^${escaped}(\\d+)?$`));
              if (match) {
                const suffix = match[1] ? parseInt(match[1], 10) : 0;
                if (!isNaN(suffix)) {
                  taken.add(suffix);
                }
              }
            });
          
            // If plain project name (suffix 0) is free, use it
            if (!taken.has(0)) return <%= baseNameField %>;
          
            // Find next available number
            let i = 1;
            while (taken.has(i)) i++;
          
            return `${<%= baseNameField %>}${i}`

    } catch (err) {
      //**errorLog
      console.log(err);
      throw new HttpServerError("errMsg_dbErrorWhenGettingNextCodenameFor<%= dbObject.modelName %>", err);
    }
};

module.exports =  getNextCodenameFor<%= dbObject.modelName %>;